<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | Eastern Shore Auction House</title>
    <style>
        /* --- CSS STYLES --- */
        :root { --primary-color: #2563eb; --header-bg: #111827; --text-color: #1f2937; --bg-color: #f3f4f6; --success-color: #10b981; --live-color: #dc2626; --ended-color: #f59e0b; --fail-color: #6b7280; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg-color); color: var(--text-color); margin: 0; }
        
        /* HEADER */
        header { background: var(--header-bg); color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center; }
        .brand { font-family: "Georgia", serif; font-size: 1.5rem; font-weight: bold; }
        .nav-links button { background: transparent; border: 1px solid #4b5563; color: white; padding: 8px 15px; cursor: pointer; border-radius: 4px; margin-left: 10px; }
        .nav-links button.active { background: var(--primary-color); border-color: var(--primary-color); }
        .nav-links button:hover { background: #374151; }

        .container { max-width: 1200px; margin: 30px auto; padding: 20px; }
        
        /* TABLES */
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #e5e7eb; }
        th { background: #f9fafb; font-weight: bold; color: #6b7280; font-size: 0.85rem; text-transform: uppercase; }
        tr { transition: all 0.3s ease; }
        tr:hover { background: #f9fafb; }
        
        /* LIVE ROW STYLES */
        tr.live-active-row { background-color: #ecfdf5 !important; border-left: 5px solid var(--success-color); }
        tr.live-ended-sold { background-color: #fffbeb !important; border-left: 5px solid var(--ended-color); }
        tr.live-ended-unsold { background-color: #f3f4f6 !important; border-left: 5px solid var(--fail-color); opacity: 0.8; }

        /* BADGES */
        .badge { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; margin-right: 8px; vertical-align: middle; text-transform: uppercase; }
        .badge-live { background: var(--live-color); color: white; animation: pulse 1.5s infinite; }
        .badge-sold { background: var(--ended-color); color: white; }
        .badge-passed { background: var(--fail-color); color: white; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }

        .live-bid-info { font-weight: bold; font-size: 1rem; display: block; }
        .live-bidder-name { font-size: 0.8rem; color: #6b7280; font-weight: normal; }

        /* STATUS PILLS */
        .status-pill { padding: 4px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: bold; text-transform: uppercase; }
        .status-new { background: #dbeafe; color: #1e40af; }
        .status-run { background: #f3f4f6; color: #374151; }
        .status-approved { background: #dcfce7; color: #166534; }
        .status-pending { background: #fee2e2; color: #991b1b; }

        .text-sold { color: #b45309; font-weight: bold; }
        .text-passed { color: #6b7280; font-style: italic; }

        input[type="checkbox"] { width: 20px; height: 20px; cursor: pointer; accent-color: var(--primary-color); }

        /* CONTACT INFO IN TABLE */
        .contact-info { font-size: 0.9rem; }
        .contact-label { font-size: 0.75rem; color: #9ca3af; text-transform: uppercase; font-weight: bold; }

        /* FORMS */
        .form-card { background: white; padding: 30px; border-radius: 8px; max-width: 600px; margin: 0 auto; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.9rem; }
        .form-group input, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        
        /* SCHEDULE CONTROL */
        .control-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 30px; display: flex; align-items: center; gap: 15px; border-left: 5px solid var(--primary-color); }
        .control-card h3 { margin: 0; white-space: nowrap; font-size: 1.1rem; }
        .control-input { flex: 1; padding: 10px; border: 1px solid #ccc; border-radius: 4px; }

        /* ACTIONS */
        .btn { padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem; font-weight: bold; color: white; }
        .btn-queue { background: #16a34a; }
        .btn-edit { background: #2563eb; }
        .btn-delete { background: #dc2626; }
        .btn-save { background: #111827; width: 100%; padding: 12px; margin-top: 10px; }

        .view-section { display: none; }
        .view-section.active { display: block; }
        .img-preview { width: 50px; height: 50px; object-fit: cover; border-radius: 4px; vertical-align: middle; margin-right: 10px; }
    </style>
</head>
<body>

    <header>
        <div class="brand">Admin Dashboard</div>
        <div class="nav-links">
            <button onclick="switchView('inventory')" class="active">Inventory</button>
            <button onclick="switchView('users')">User Manager</button>
            <button onclick="switchView('history')">Sales History</button>
            <button onclick="switchView('add')">Add New Lot</button>
            <button onclick="location.href='auction.html'" style="border-color:white;">Live Auction &rarr;</button>
        </div>
    </header>

    <div class="container">
        
        <div id="inventoryView" class="view-section active">
            <div class="control-card">
                <h3>üìÖ Update Auction Date:</h3>
                <input type="text" id="scheduleInput" class="control-input" placeholder="e.g. Tonight at 7:00 PM CST">
                <button class="btn btn-edit" onclick="updateSchedule()">Update</button>
            </div>

            <h2>Item Inventory</h2>
            <table>
                <thead>
                    <tr>
                        <th style="text-align:center;">Feat</th>
                        <th>Lot #</th>
                        <th>Item</th>
                        <th>Seller</th>
                        <th>Status / Price</th>
                        <th>Run</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="inventoryTableBody">
                    <tr><td colspan="7" style="text-align:center;">Loading inventory...</td></tr>
                </tbody>
            </table>
        </div>

        <div id="usersView" class="view-section">
            <h2>User Management</h2>
            <table>
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Local?</th>
                        <th>Pickup Plan</th>
                        <th>Status</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="usersTableBody">
                    <tr><td colspan="6" style="text-align:center;">Loading users...</td></tr>
                </tbody>
            </table>
        </div>

        <div id="historyView" class="view-section">
            <h2>Sales History (Sold Lots)</h2>
            <table>
                <thead>
                    <tr>
                        <th>Lot #</th>
                        <th>Item</th>
                        <th>Sold Price</th>
                        <th>Buyer Contact</th>
                        <th>Seller Contact</th>
                        <th>Date</th>
                    </tr>
                </thead>
                <tbody id="salesTableBody">
                    <tr><td colspan="6" style="text-align:center;">Loading history...</td></tr>
                </tbody>
            </table>
        </div>

        <div id="addView" class="view-section">
            <h2 id="formTitle">Add New Lot</h2>
            <div class="form-card">
                <form onsubmit="event.preventDefault(); saveItem();">
                    <input type="hidden" id="editKey"> 
                    
                    <div class="form-group"><label>Lot Number:</label><input type="number" id="inpLot" required placeholder="e.g. 101"></div>
                    <div class="form-group"><label>Title:</label><input type="text" id="inpTitle" required></div>
                    <div class="form-group"><label>Subtitle:</label><input type="text" id="inpSub" placeholder="Condition / Category"></div>
                    
                    <div class="form-group"><label>Seller Name / Username:</label><input type="text" id="inpSeller" placeholder="e.g. Jamie R."></div>
                    
                    <div class="form-group"><label>Start Bid ($):</label><input type="number" id="inpPrice" required></div>
                    <div class="form-group"><label>Reserve Price ($):</label><input type="number" id="inpReserve" placeholder="Hidden Minimum"></div>
                    <div class="form-group"><label>Main Image URL:</label><input type="text" id="inpImg" required></div>
                    <div class="form-group"><label>Description:</label><textarea id="inpDesc" rows="4"></textarea></div>
                    <h3>Extra Images</h3>
                    <div class="form-group"><input type="text" id="inpThumb1" placeholder="URL 1"></div>
                    <div class="form-group"><input type="text" id="inpThumb2" placeholder="URL 2"></div>
                    <div class="form-group"><input type="text" id="inpThumb3" placeholder="URL 3"></div>
                    <div class="form-group"><input type="text" id="inpThumb4" placeholder="URL 4"></div>
                    <button type="submit" class="btn btn-save">Save Item</button>
                </form>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, onValue, set, push, remove, update, child, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // --- PASTE KEYS HERE ---
        const firebaseConfig = {
  apiKey: "AIzaSyCt0i8a7ZVRlNmSts9yM4uGwV7ghPU59rk",
  authDomain: "eastern-shore-auction.firebaseapp.com",
  databaseURL: "https://eastern-shore-auction-default-rtdb.firebaseio.com",
  projectId: "eastern-shore-auction",
  storageBucket: "eastern-shore-auction.firebasestorage.app",
  messagingSenderId: "771348898846",
  appId: "1:771348898846:web:3b6371e8f826747fdcba0f"
};

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // --- 1. AUTH CHECK ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                get(child(ref(db), `admins/${user.uid}`)).then((snapshot) => {
                    if (!snapshot.exists() || snapshot.val() !== true) {
                        alert("Access Denied."); window.location.href = "index.html";
                    } else {
                        loadInventory();
                        loadUsers();
                        loadHistory();
                        monitorActiveAuction();
                        loadSchedule();
                    }
                });
            } else {
                window.location.href = "index.html";
            }
        });

        // --- SCHEDULE ---
        function loadSchedule() {
            get(ref(db, 'auction_schedule')).then((snapshot) => {
                if(snapshot.exists()) document.getElementById('scheduleInput').value = snapshot.val();
            });
        }
        window.updateSchedule = function() {
            const newText = document.getElementById('scheduleInput').value;
            set(ref(db, 'auction_schedule'), newText).then(() => { alert("Schedule updated!"); });
        }

        // --- NAVIGATION ---
        window.switchView = function(viewName) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.getElementById(viewName + 'View').classList.add('active');
            if(viewName === 'add') {
                if(!document.getElementById('editKey').value) { resetForm(); }
            }
        }
        
        function resetForm() {
            document.querySelector('form').reset();
            document.getElementById('editKey').value = "";
            document.getElementById('formTitle').innerText = "Add New Lot";
        }

        // --- SALES HISTORY ---
        function loadHistory() {
            const refHist = ref(db, 'sales_history');
            onValue(refHist, (snapshot) => {
                const tbody = document.getElementById('salesTableBody');
                tbody.innerHTML = "";
                const data = snapshot.val();
                if(!data) { tbody.innerHTML = "<tr><td colspan='6'>No sales yet.</td></tr>"; return; }
                const items = Object.values(data).sort((a, b) => b.date - a.date);
                items.forEach(item => {
                    const dateStr = new Date(item.date).toLocaleDateString();
                    const lotNum = item.lot || "Old";
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td><strong>#${lotNum}</strong></td>
                        <td>${item.item_title}</td>
                        <td style="color:#16a34a; font-weight:bold;">$${item.final_price}</td>
                        <td class="contact-info"><span class="contact-label">Name:</span> ${item.winner_name}<br><span class="contact-label">Email:</span> ${item.winner_email}</td>
                        <td class="contact-info">${item.seller_name || "N/A"}</td>
                        <td>${dateStr}</td>
                    `;
                    tbody.appendChild(tr);
                });
            });
        }

        // --- INVENTORY ---
        function loadInventory() {
            const invRef = ref(db, 'inventory');
            onValue(invRef, (snapshot) => {
                const tbody = document.getElementById('inventoryTableBody');
                tbody.innerHTML = "";
                const data = snapshot.val();
                if(!data) { tbody.innerHTML = "<tr><td colspan='7'>No items.</td></tr>"; return; }
                const items = Object.entries(data).map(([key, val]) => ({ ...val, key }));
                items.sort((a, b) => a.lot - b.lot);
                items.forEach(item => {
                    const tr = document.createElement('tr');
                    tr.id = `row-${item.key}`; 
                    tr.dataset.defaultPrice = item.start_price;
                    const isChecked = item.is_featured ? 'checked' : '';
                    
                    let statusDisplay = "";
                    if(item.status_label && item.status_label.includes("SOLD")) { statusDisplay = `<span class="text-sold">${item.status_label}</span>`; } 
                    else if(item.status_label && item.status_label.includes("PASSED")) { statusDisplay = `<span class="text-passed">${item.status_label}</span>`; } 
                    else { statusDisplay = `Start: $${item.start_price}<br><small style="color:#999">Reserve: $${item.reserve_price || 0}</small>`; }

                    tr.innerHTML = `
                        <td style="text-align:center;"><input type="checkbox" ${isChecked} onchange="toggleFeatured('${item.key}', this.checked)"></td>
                        <td><strong>#${item.lot}</strong></td>
                        <td class="item-cell"><img src="${item.image_url}" class="img-preview"><span class="item-title">${item.title}</span></td>
                        <td>${item.seller_name || "N/A"}</td>
                        <td class="price-cell">${statusDisplay}</td>
                        <td><span class="status-pill ${item.times_run > 0 ? 'status-run' : 'status-new'}">${item.times_run || 0} Times</span></td>
                        <td>
                            <button class="btn btn-queue" onclick="queueItem('${item.key}')">üì¢ Queue</button>
                            <button class="btn btn-edit" onclick="editItem('${item.key}')">‚úèÔ∏è Edit</button>
                            <button class="btn btn-delete" onclick="deleteItem('${item.key}')">üóëÔ∏è</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            });
        }

        window.toggleFeatured = function(key, status) { update(ref(db, `inventory/${key}`), { is_featured: status }); }

        // --- USERS ---
        function loadUsers() {
            const userRef = ref(db, 'users');
            onValue(userRef, (snapshot) => {
                const tbody = document.getElementById('usersTableBody');
                tbody.innerHTML = "";
                const data = snapshot.val();
                if(!data) { tbody.innerHTML = "<tr><td colspan='6'>No registered users.</td></tr>"; return; }
                Object.entries(data).forEach(([key, user]) => {
                    const isApproved = user.is_approved === true;
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td><strong>${user.name}</strong></td><td>${user.email}</td><td>${user.is_local ? 'Yes' : 'No'}</td><td>${user.pickup_plan || "N/A"}</td><td><span class="status-pill ${isApproved ? 'status-approved' : 'status-pending'}">${isApproved ? 'Active' : 'Pending'}</span></td><td>${!isApproved ? `<button class="btn btn-queue" onclick="approveUser('${key}')">Approve</button>` : ''}</td>`;
                    tbody.appendChild(tr);
                });
            });
        }
        window.approveUser = function(uid) { if(confirm("Approve this user?")) update(ref(db, `users/${uid}`), { is_approved: true }); }

        // --- MONITOR ---
        let activeAuctionData = null;
        function monitorActiveAuction() {
            const activeRef = ref(db, 'active_auction');
            onValue(activeRef, (snapshot) => { activeAuctionData = snapshot.val(); updateActiveRowUI(); });
            setInterval(updateActiveRowUI, 1000);
        }

        function updateActiveRowUI() {
            document.querySelectorAll('.live-active-row, .live-ended-sold, .live-ended-unsold').forEach(row => {
                row.classList.remove('live-active-row', 'live-ended-sold', 'live-ended-unsold');
                const titleCell = row.querySelector('.item-title');
                const badge = row.querySelector('.badge-live, .badge-sold, .badge-passed');
                if(badge) badge.remove();
                const priceCell = row.querySelector('.price-cell');
                priceCell.innerHTML = "$" + row.dataset.defaultPrice;
            });

            if (activeAuctionData && activeAuctionData.inventory_key) {
                const row = document.getElementById(`row-${activeAuctionData.inventory_key}`);
                if (row) {
                    const isEnded = Date.now() > activeAuctionData.end_time;
                    const bidder = activeAuctionData.high_bidder_name ? activeAuctionData.high_bidder_name : "No Bids";
                    const priceCell = row.querySelector('.price-cell');
                    const titleCell = row.querySelector('.item-title');
                    const currentBid = activeAuctionData.current_bid || 0;
                    const reserve = activeAuctionData.reserve_price || 0;
                    const hasBidder = !!activeAuctionData.high_bidder_uid;

                    if (isEnded) {
                        if (hasBidder && currentBid >= reserve) {
                            row.classList.add('live-ended-sold');
                            if (!row.querySelector('.badge-sold')) titleCell.insertAdjacentHTML('afterbegin', '<span class="badge badge-sold">SOLD</span>');
                            priceCell.innerHTML = `<span class="live-bid-info" style="color: #b45309;">SOLD: $${currentBid.toLocaleString()}</span><span class="live-bidder-name">Winner: ${bidder}</span>`;
                        } else {
                            row.classList.add('live-ended-unsold');
                            if (!row.querySelector('.badge-passed')) titleCell.insertAdjacentHTML('afterbegin', '<span class="badge badge-passed">PASSED</span>');
                            priceCell.innerHTML = `<span class="live-bid-info" style="color: #6b7280;">Ended: $${currentBid.toLocaleString()}</span><span class="live-bidder-name" style="color:#dc2626;">Reserve Not Met</span>`;
                        }
                    } else {
                        row.classList.add('live-active-row');
                        if (!row.querySelector('.badge-live')) titleCell.insertAdjacentHTML('afterbegin', '<span class="badge badge-live">LIVE</span>');
                        priceCell.innerHTML = `<span class="live-bid-info" style="color: #10b981;">$${currentBid.toLocaleString()}</span><span class="live-bidder-name">High Bidder: ${bidder}</span>`;
                    }
                }
            }
        }

        // --- CRUD & QUEUE ---
        window.saveItem = function() {
            const key = document.getElementById('editKey').value;
            const data = {
                lot: parseInt(document.getElementById('inpLot').value),
                title: document.getElementById('inpTitle').value,
                subtitle: document.getElementById('inpSub').value,
                seller_name: document.getElementById('inpSeller').value,
                start_price: parseInt(document.getElementById('inpPrice').value),
                reserve_price: parseInt(document.getElementById('inpReserve').value) || 0,
                image_url: document.getElementById('inpImg').value,
                description: document.getElementById('inpDesc').value,
                times_run: 0, is_featured: false,
                images: { thumb1: document.getElementById('inpThumb1').value, thumb2: document.getElementById('inpThumb2').value, thumb3: document.getElementById('inpThumb3').value, thumb4: document.getElementById('inpThumb4').value }
            };
            if(key) {
                get(ref(db, `inventory/${key}`)).then((snap) => {
                    const existing = snap.val();
                    data.times_run = existing.times_run || 0; data.is_featured = existing.is_featured || false; data.status_label = existing.status_label || "";
                    update(ref(db, `inventory/${key}`), data); alert("Item Updated"); resetForm(); switchView('inventory');
                });
            } else { push(ref(db, 'inventory'), data); alert("Item Added"); resetForm(); switchView('inventory'); }
        }

        window.deleteItem = function(key) { if(confirm("Delete item?")) remove(ref(db, `inventory/${key}`)); }
        
        window.editItem = function(key) {
            resetForm(); 
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.getElementById('addView').classList.add('active'); document.getElementById('formTitle').innerText = "Edit Item";
            get(ref(db, `inventory/${key}`)).then((snapshot) => {
                const data = snapshot.val();
                document.getElementById('editKey').value = key;
                document.getElementById('inpLot').value = data.lot;
                document.getElementById('inpTitle').value = data.title;
                document.getElementById('inpSub').value = data.subtitle;
                document.getElementById('inpSeller').value = data.seller_name;
                document.getElementById('inpPrice').value = data.start_price;
                document.getElementById('inpReserve').value = data.reserve_price || "";
                document.getElementById('inpImg').value = data.image_url;
                document.getElementById('inpDesc').value = data.description;
                if(data.images) {
                    document.getElementById('inpThumb1').value = data.images.thumb1 || "";
                    document.getElementById('inpThumb2').value = data.images.thumb2 || "";
                    document.getElementById('inpThumb3').value = data.images.thumb3 || "";
                    document.getElementById('inpThumb4').value = data.images.thumb4 || "";
                }
            });
        }

        window.queueItem = function(newKey) {
            get(ref(db, `inventory/${newKey}`)).then((newSnap) => {
                const newItem = newSnap.val();
                get(ref(db, 'active_auction')).then((activeSnap) => {
                    const currentAuction = activeSnap.val();
                    const startNew = () => {
                        const auctionData = {
                            lot: newItem.lot, 
                            title: newItem.title, subtitle: newItem.subtitle, description: newItem.description,
                            current_bid: newItem.start_price, image_url: newItem.image_url,
                            reserve_price: newItem.reserve_price || 0,
                            end_time: Date.now() + (6 * 60 * 1000),
                            images: newItem.images,
                            high_bidder_max: 0, high_bidder_name: "", high_bidder_uid: "", bid_history: null,
                            inventory_key: newKey, seller_name: newItem.seller_name
                        };
                        set(ref(db, 'active_auction'), auctionData);
                        update(ref(db, `inventory/${newKey}`), { times_run: (newItem.times_run || 0) + 1, status_label: "LIVE" });
                        alert("Item is LIVE!");
                    };

                    if (currentAuction && currentAuction.inventory_key && currentAuction.inventory_key !== "undefined") {
                        const reserve = currentAuction.reserve_price || 0;
                        const finalBid = currentAuction.current_bid || 0;
                        const hasBidder = !!currentAuction.high_bidder_uid;
                        let statusLabel = "PASSED";
                        let isSold = false;
                        if (hasBidder && finalBid >= reserve) { statusLabel = `SOLD: $${finalBid}`; isSold = true; } 
                        else { statusLabel = hasBidder ? "PASSED (Reserve)" : "PASSED (No Bids)"; }
                        update(ref(db, `inventory/${currentAuction.inventory_key}`), { status_label: statusLabel });

                        if (isSold) {
                            get(ref(db, `users/${currentAuction.high_bidder_uid}`)).then((userSnap) => {
                                const winnerEmail = userSnap.exists() ? userSnap.val().email : "Unknown";
                                saveHistoryRecord(currentAuction, finalBid, winnerEmail, startNew);
                            }).catch(() => { saveHistoryRecord(currentAuction, finalBid, "Error fetching email", startNew); });
                        } else { startNew(); }
                    } else { startNew(); }
                });
            });
        }

        function saveHistoryRecord(auction, price, email, callback) {
            push(ref(db, 'sales_history'), {
                lot: auction.lot || "?",
                item_title: auction.title,
                final_price: price,
                winner_name: auction.high_bidder_name || "Unknown",
                winner_email: email,
                seller_name: auction.seller_name || "N/A",
                date: Date.now()
            }).then(() => { callback(); });
        }
    </script>
</body>
</html>