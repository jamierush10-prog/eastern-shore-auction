<script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, onValue, set, push, remove, update, child, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // --- PASTE YOUR KEYS HERE ---
        const firebaseConfig = {
  apiKey: "AIzaSyCt0i8a7ZVRlNmSts9yM4uGwV7ghPU59rk",
  authDomain: "eastern-shore-auction.firebaseapp.com",
  databaseURL: "https://eastern-shore-auction-default-rtdb.firebaseio.com",
  projectId: "eastern-shore-auction",
  storageBucket: "eastern-shore-auction.firebasestorage.app",
  messagingSenderId: "771348898846",
  appId: "1:771348898846:web:3b6371e8f826747fdcba0f"
};

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        onAuthStateChanged(auth, (user) => {
            if (user) {
                get(child(ref(db), `admins/${user.uid}`)).then((snapshot) => {
                    if (!snapshot.exists() || snapshot.val() !== true) {
                        alert("Access Denied."); window.location.href = "index.html";
                    } else {
                        loadInventory();
                        loadUsers();
                        loadHistory();
                        monitorActiveAuction();
                        loadSchedule();
                    }
                });
            } else {
                window.location.href = "index.html";
            }
        });

        // --- SCHEDULE ---
        function loadSchedule() {
            get(ref(db, 'auction_schedule')).then((snapshot) => {
                if(snapshot.exists()) document.getElementById('scheduleInput').value = snapshot.val();
            });
        }
        window.updateSchedule = function() {
            const newText = document.getElementById('scheduleInput').value;
            set(ref(db, 'auction_schedule'), newText).then(() => { alert("Schedule updated!"); });
        }

        // --- NAVIGATION ---
        window.switchView = function(viewName) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.getElementById(viewName + 'View').classList.add('active');
            if(viewName === 'add' && !document.getElementById('editKey').value) { resetForm(); }
        }
        
        function resetForm() {
            document.querySelector('form').reset();
            document.getElementById('editKey').value = "";
            document.getElementById('formTitle').innerText = "Add New Lot";
        }

        // --- SALES HISTORY ---
        function loadHistory() {
            const refHist = ref(db, 'sales_history');
            onValue(refHist, (snapshot) => {
                const tbody = document.getElementById('salesTableBody');
                tbody.innerHTML = "";
                const data = snapshot.val();
                if(!data) { tbody.innerHTML = "<tr><td colspan='6'>No sales yet.</td></tr>"; return; }
                const items = Object.values(data).sort((a, b) => b.date - a.date);
                items.forEach(item => {
                    const dateStr = new Date(item.date).toLocaleDateString();
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td><strong>#${item.lot || "?"}</strong></td><td>${item.item_title}</td><td style="color:#16a34a; font-weight:bold;">$${item.final_price}</td><td>${item.winner_name}<br><small>${item.winner_email}</small></td><td>${item.seller_name || "N/A"}</td><td>${dateStr}</td>`;
                    tbody.appendChild(tr);
                });
            });
        }

        // --- INVENTORY ---
        function loadInventory() {
            const invRef = ref(db, 'inventory');
            onValue(invRef, (snapshot) => {
                const tbody = document.getElementById('inventoryTableBody');
                tbody.innerHTML = "";
                const data = snapshot.val();
                if(!data) { tbody.innerHTML = "<tr><td colspan='7'>No items.</td></tr>"; return; }
                const items = Object.entries(data).map(([key, val]) => ({ ...val, key }));
                items.sort((a, b) => a.lot - b.lot);
                items.forEach(item => {
                    const tr = document.createElement('tr');
                    tr.id = `row-${item.key}`; 
                    tr.dataset.defaultPrice = item.start_price;
                    const isChecked = item.is_featured ? 'checked' : '';
                    let statusDisplay = "";
                    if(item.status_label && item.status_label.includes("SOLD")) { statusDisplay = `<span class="text-sold">${item.status_label}</span>`; } 
                    else if(item.status_label && item.status_label.includes("PASSED")) { statusDisplay = `<span class="text-passed">${item.status_label}</span>`; } 
                    else { statusDisplay = `Start: $${item.start_price}<br><small style="color:#999">Reserve: $${item.reserve_price || 0}</small>`; }

                    tr.innerHTML = `
                        <td style="text-align:center;"><input type="checkbox" ${isChecked} onchange="toggleFeatured('${item.key}', this.checked)"></td>
                        <td><strong>#${item.lot}</strong></td>
                        <td class="item-cell"><img src="${item.image_url}" class="img-preview"><span class="item-title">${item.title}</span></td>
                        <td>${item.seller_name || "N/A"}</td>
                        <td class="price-cell">${statusDisplay}</td>
                        <td><span class="status-pill ${item.times_run > 0 ? 'status-run' : 'status-new'}">${item.times_run || 0} Times</span></td>
                        <td>
                            <button class="btn btn-queue" onclick="queueItem('${item.key}')">üì¢ Queue</button>
                            <button class="btn btn-edit" onclick="editItem('${item.key}')">‚úèÔ∏è Edit</button>
                            <button class="btn btn-delete" onclick="deleteItem('${item.key}')">üóëÔ∏è</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            });
        }

        window.toggleFeatured = function(key, status) { update(ref(db, `inventory/${key}`), { is_featured: status }); }

        // --- USERS ---
        function loadUsers() {
            const userRef = ref(db, 'users');
            onValue(userRef, (snapshot) => {
                const tbody = document.getElementById('usersTableBody');
                tbody.innerHTML = "";
                const data = snapshot.val();
                if(!data) { tbody.innerHTML = "<tr><td colspan='6'>No registered users.</td></tr>"; return; }
                Object.entries(data).forEach(([key, user]) => {
                    const isApproved = user.is_approved === true;
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td><strong>${user.name}</strong></td><td>${user.email}</td><td>${user.is_local ? 'Yes' : 'No'}</td><td>${user.pickup_plan || "N/A"}</td><td><span class="status-pill ${isApproved ? 'status-approved' : 'status-pending'}">${isApproved ? 'Active' : 'Pending'}</span></td><td>${!isApproved ? `<button class="btn btn-queue" onclick="approveUser('${key}')">Approve</button>` : ''}</td>`;
                    tbody.appendChild(tr);
                });
            });
        }
        window.approveUser = function(uid) { if(confirm("Approve this user?")) update(ref(db, `users/${uid}`), { is_approved: true }); }

        // --- MONITOR ---
        let activeAuctionData = null;
        function monitorActiveAuction() {
            const activeRef = ref(db, 'active_auction');
            onValue(activeRef, (snapshot) => { activeAuctionData = snapshot.val(); updateActiveRowUI(); });
            setInterval(updateActiveRowUI, 1000);
        }

        function updateActiveRowUI() {
            document.querySelectorAll('.live-active-row, .live-ended-sold, .live-ended-unsold').forEach(row => {
                row.classList.remove('live-active-row', 'live-ended-sold', 'live-ended-unsold');
                const titleCell = row.querySelector('.item-title');
                const badge = row.querySelector('.live-badge, .ended-badge');
                if(badge) badge.remove();
                const priceCell = row.querySelector('.price-cell');
                priceCell.innerHTML = "$" + row.dataset.defaultPrice;
            });

            if (activeAuctionData && activeAuctionData.inventory_key) {
                const row = document.getElementById(`row-${activeAuctionData.inventory_key}`);
                if (row) {
                    const isEnded = Date.now() > activeAuctionData.end_time;
                    const bidder = activeAuctionData.high_bidder_name ? activeAuctionData.high_bidder_name : "No Bids";
                    const priceCell = row.querySelector('.price-cell');
                    const titleCell = row.querySelector('.item-title');
                    const currentBid = activeAuctionData.current_bid || 0;
                    const reserve = activeAuctionData.reserve_price || 0;
                    const hasBidder = !!activeAuctionData.high_bidder_uid;

                    if (isEnded) {
                        if (hasBidder && currentBid >= reserve) {
                            row.classList.add('live-ended-sold');
                            if (!row.querySelector('.ended-badge')) titleCell.insertAdjacentHTML('afterbegin', '<span class="ended-badge">SOLD</span>');
                            priceCell.innerHTML = `<span class="live-bid-info" style="color: #b45309;">SOLD: $${currentBid.toLocaleString()}</span><span class="live-bidder-name">Winner: ${bidder}</span>`;
                        } else {
                            row.classList.add('live-ended-unsold');
                            if (!row.querySelector('.ended-badge')) titleCell.insertAdjacentHTML('afterbegin', '<span class="ended-badge">PASSED</span>');
                            priceCell.innerHTML = `<span class="live-bid-info" style="color: #6b7280;">Ended: $${currentBid.toLocaleString()}</span><span class="live-bidder-name" style="color:#dc2626;">Reserve Not Met</span>`;
                        }
                    } else {
                        row.classList.add('live-active-row');
                        if (!row.querySelector('.live-badge')) titleCell.insertAdjacentHTML('afterbegin', '<span class="live-badge">LIVE</span>');
                        priceCell.innerHTML = `<span class="live-bid-info" style="color: #10b981;">$${currentBid.toLocaleString()}</span><span class="live-bidder-name">High Bidder: ${bidder}</span>`;
                    }
                }
            }
        }

        // --- CRUD ---
        window.saveItem = function() {
            const key = document.getElementById('editKey').value;
            const data = {
                lot: parseInt(document.getElementById('inpLot').value),
                title: document.getElementById('inpTitle').value,
                subtitle: document.getElementById('inpSub').value,
                seller_name: document.getElementById('inpSeller').value,
                start_price: parseInt(document.getElementById('inpPrice').value),
                reserve_price: parseInt(document.getElementById('inpReserve').value) || 0,
                image_url: document.getElementById('inpImg').value,
                description: document.getElementById('inpDesc').value,
                times_run: 0, is_featured: false,
                images: { thumb1: document.getElementById('inpThumb1').value, thumb2: document.getElementById('inpThumb2').value, thumb3: document.getElementById('inpThumb3').value, thumb4: document.getElementById('inpThumb4').value }
            };
            if(key) {
                get(ref(db, `inventory/${key}`)).then((snap) => {
                    const existing = snap.val();
                    data.times_run = existing.times_run || 0; data.is_featured = existing.is_featured || false; data.status_label = existing.status_label || "";
                    update(ref(db, `inventory/${key}`), data); alert("Item Updated"); resetForm(); switchView('inventory');
                });
            } else { push(ref(db, 'inventory'), data); alert("Item Added"); resetForm(); switchView('inventory'); }
        }

        window.deleteItem = function(key) { if(confirm("Delete item?")) remove(ref(db, `inventory/${key}`)); }
        window.editItem = function(key) {
            resetForm(); document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.getElementById('addView').classList.add('active'); document.getElementById('formTitle').innerText = "Edit Item";
            get(ref(db, `inventory/${key}`)).then((snapshot) => {
                const data = snapshot.val();
                document.getElementById('editKey').value = key;
                document.getElementById('inpLot').value = data.lot;
                document.getElementById('inpTitle').value = data.title;
                document.getElementById('inpSub').value = data.subtitle;
                document.getElementById('inpSeller').value = data.seller_name;
                document.getElementById('inpPrice').value = data.start_price;
                document.getElementById('inpReserve').value = data.reserve_price || "";
                document.getElementById('inpImg').value = data.image_url;
                document.getElementById('inpDesc').value = data.description;
                if(data.images) {
                    document.getElementById('inpThumb1').value = data.images.thumb1 || "";
                    document.getElementById('inpThumb2').value = data.images.thumb2 || "";
                    document.getElementById('inpThumb3').value = data.images.thumb3 || "";
                    document.getElementById('inpThumb4').value = data.images.thumb4 || "";
                }
            });
        }

        // --- BULLETPROOF QUEUE ITEM ---
        window.queueItem = function(newKey) {
            // 1. Get NEW item data
            get(ref(db, `inventory/${newKey}`)).then((newSnap) => {
                const newItem = newSnap.val();

                // 2. Get CURRENT active auction to archive it
                get(ref(db, 'active_auction')).then((activeSnap) => {
                    const currentAuction = activeSnap.val();

                    // Define the function to Start the New Auction
                    const startNew = () => {
                        const auctionData = {
                            lot: newItem.lot, 
                            title: newItem.title, subtitle: newItem.subtitle, description: newItem.description,
                            current_bid: newItem.start_price, image_url: newItem.image_url,
                            reserve_price: newItem.reserve_price || 0,
                            end_time: Date.now() + (6 * 60 * 1000), // 6 minutes
                            images: newItem.images,
                            high_bidder_max: 0, high_bidder_name: "", high_bidder_uid: "", bid_history: null,
                            inventory_key: newKey, seller_name: newItem.seller_name
                        };
                        set(ref(db, 'active_auction'), auctionData);
                        update(ref(db, `inventory/${newKey}`), { times_run: (newItem.times_run || 0) + 1, status_label: "LIVE" });
                        alert("Item is LIVE!");
                    };

                    // 3. Safe Archive Logic
                    // Only attempt to archive if we have valid data and a valid key
                    if (currentAuction && currentAuction.inventory_key && currentAuction.inventory_key !== "undefined") {
                        const reserve = currentAuction.reserve_price || 0;
                        const finalBid = currentAuction.current_bid || 0;
                        const hasBidder = !!currentAuction.high_bidder_uid;
                        let statusLabel = "PASSED";
                        let isSold = false;

                        if (hasBidder && finalBid >= reserve) { statusLabel = `SOLD: $${finalBid}`; isSold = true; } 
                        else { statusLabel = hasBidder ? "PASSED (Reserve)" : "PASSED (No Bids)"; }

                        // Update the OLD item status in inventory
                        update(ref(db, `inventory/${currentAuction.inventory_key}`), { status_label: statusLabel });

                        if (isSold) {
                            get(ref(db, `users/${currentAuction.high_bidder_uid}`)).then((userSnap) => {
                                const winnerEmail = userSnap.exists() ? userSnap.val().email : "Unknown";
                                push(ref(db, 'sales_history'), {
                                    lot: currentAuction.lot, 
                                    item_title: currentAuction.title,
                                    final_price: finalBid,
                                    winner_name: currentAuction.high_bidder_name,
                                    winner_email: winnerEmail,
                                    seller_name: currentAuction.seller_name, 
                                    date: Date.now()
                                });
                                startNew(); // Start next after saving history
                            }).catch(() => {
                                // If user fetch fails, force start anyway
                                startNew();
                            });
                        } else { 
                            startNew(); 
                        }
                    } else { 
                        // Data was corrupt or empty, just start fresh
                        startNew(); 
                    }
                });
            });
        }
    </script>