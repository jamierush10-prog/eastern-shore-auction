<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | Eastern Shore Auction House</title>
    <style>
        /* --- CSS STYLES --- */
        :root { --primary-color: #2563eb; --header-bg: #111827; --text-color: #1f2937; --bg-color: #f3f4f6; --success-color: #10b981; --live-color: #dc2626; --ended-color: #f59e0b; --fail-color: #6b7280; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg-color); color: var(--text-color); margin: 0; }
        
        /* HEADER */
        header { background: var(--header-bg); color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center; }
        .brand { font-family: "Georgia", serif; font-size: 1.5rem; font-weight: bold; }
        .nav-links button { background: transparent; border: 1px solid #4b5563; color: white; padding: 8px 15px; cursor: pointer; border-radius: 4px; margin-left: 10px; }
        .nav-links button.active { background: var(--primary-color); border-color: var(--primary-color); }
        .nav-links button:hover { background: #374151; }

        /* CONTAINER */
        .container { max-width: 1200px; margin: 30px auto; padding: 20px; }
        
        /* TABLES */
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #e5e7eb; }
        th { background: #f9fafb; font-weight: bold; color: #6b7280; font-size: 0.85rem; text-transform: uppercase; }
        tr { transition: all 0.3s ease; }
        tr:hover { background: #f9fafb; }
        
        /* LIVE ROW STYLES */
        tr.live-active-row { background-color: #ecfdf5 !important; border-left: 5px solid var(--success-color); }
        tr.live-ended-sold { background-color: #fffbeb !important; border-left: 5px solid var(--ended-color); }
        tr.live-ended-unsold { background-color: #f3f4f6 !important; border-left: 5px solid var(--fail-color); opacity: 0.8; }

        .live-badge { display: inline-block; background: var(--live-color); color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; margin-right: 8px; vertical-align: middle; text-transform: uppercase; animation: pulse 1.5s infinite; }
        .sold-badge { display: inline-block; background: var(--ended-color); color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; margin-right: 8px; vertical-align: middle; text-transform: uppercase; }
        .unsold-badge { display: inline-block; background: var(--fail-color); color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; margin-right: 8px; vertical-align: middle; text-transform: uppercase; }
        
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }

        .live-bid-info { font-weight: bold; font-size: 1rem; display: block; }
        .live-bidder-name { font-size: 0.8rem; color: #6b7280; font-weight: normal; }

        /* STATUS PILLS */
        .status-pill { padding: 4px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: bold; text-transform: uppercase; }
        .status-new { background: #dbeafe; color: #1e40af; }
        .status-run { background: #f3f4f6; color: #374151; }
        .status-approved { background: #dcfce7; color: #166534; }
        .status-pending { background: #fee2e2; color: #991b1b; }

        /* CHECKBOX */
        input[type="checkbox"] { width: 20px; height: 20px; cursor: pointer; accent-color: var(--primary-color); }

        /* FORMS */
        .form-card { background: white; padding: 30px; border-radius: 8px; max-width: 600px; margin: 0 auto; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.9rem; }
        .form-group input, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .row-group { display: flex; gap: 15px; }
        
        /* ACTIONS */
        .btn { padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem; font-weight: bold; color: white; }
        .btn-queue { background: #16a34a; }
        .btn-edit { background: #2563eb; }
        .btn-delete { background: #dc2626; }
        .btn-save { background: #111827; width: 100%; padding: 12px; margin-top: 10px; }

        /* VIEWS */
        .view-section { display: none; }
        .view-section.active { display: block; }
        .img-preview { width: 50px; height: 50px; object-fit: cover; border-radius: 4px; vertical-align: middle; margin-right: 10px; }
    </style>
</head>
<body>

    <header>
        <div class="brand">Admin Dashboard</div>
        <div class="nav-links">
            <button onclick="switchView('inventory')" class="active">Inventory</button>
            <button onclick="switchView('users')">User Manager</button>
            <button onclick="switchView('add')">Add New Lot</button>
            <button onclick="location.href='auction.html'" style="border-color:white;">Live Auction &rarr;</button>
        </div>
    </header>

    <div class="container">
        
        <div id="inventoryView" class="view-section active">
            <h2>Item Inventory</h2>
            <table>
                <thead>
                    <tr>
                        <th style="text-align:center;">Feat</th>
                        <th>Lot #</th>
                        <th>Item</th>
                        <th>Seller</th>
                        <th>Status / Price</th>
                        <th>Run</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="inventoryTableBody">
                    <tr><td colspan="7" style="text-align:center;">Loading inventory...</td></tr>
                </tbody>
            </table>
        </div>

        <div id="usersView" class="view-section">
            <h2>User Management</h2>
            <table>
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Local?</th>
                        <th>Pickup Plan</th>
                        <th>Status</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="usersTableBody">
                    <tr><td colspan="6" style="text-align:center;">Loading users...</td></tr>
                </tbody>
            </table>
        </div>

        <div id="addView" class="view-section">
            <h2 id="formTitle">Add New Lot</h2>
            <div class="form-card">
                <form onsubmit="event.preventDefault(); saveItem();">
                    <input type="hidden" id="editKey"> <div class="row-group">
                        <div class="form-group" style="flex:1;"><label>Lot Number:</label><input type="number" id="inpLot" required placeholder="e.g. 101"></div>
                        <div class="form-group" style="flex:2;"><label>Title:</label><input type="text" id="inpTitle" required></div>
                    </div>
                    <div class="form-group"><label>Subtitle:</label><input type="text" id="inpSub" placeholder="Condition / Category"></div>
                    <div class="form-group"><label>Seller Email:</label><input type="email" id="inpSeller"></div>
                    
                    <div class="row-group">
                        <div class="form-group" style="flex:1;"><label>Start Bid ($):</label><input type="number" id="inpPrice" required></div>
                        <div class="form-group" style="flex:1;"><label>Reserve Price ($):</label><input type="number" id="inpReserve" placeholder="Hidden Minimum"></div>
                    </div>

                    <div class="form-group"><label>Main Image URL:</label><input type="text" id="inpImg" required></div>
                    <div class="form-group"><label>Description:</label><textarea id="inpDesc" rows="4"></textarea></div>
                    
                    <h3>Extra Images</h3>
                    <div class="form-group"><input type="text" id="inpThumb1" placeholder="URL 1"></div>
                    <div class="form-group"><input type="text" id="inpThumb2" placeholder="URL 2"></div>
                    <div class="form-group"><input type="text" id="inpThumb3" placeholder="URL 3"></div>
                    <div class="form-group"><input type="text" id="inpThumb4" placeholder="URL 4"></div>

                    <button type="submit" class="btn btn-save">Save Item</button>
                </form>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, onValue, set, push, remove, update, child, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // --- PASTE KEYS HERE ---
        const firebaseConfig = {
  apiKey: "AIzaSyCt0i8a7ZVRlNmSts9yM4uGwV7ghPU59rk",
  authDomain: "eastern-shore-auction.firebaseapp.com",
  databaseURL: "https://eastern-shore-auction-default-rtdb.firebaseio.com",
  projectId: "eastern-shore-auction",
  storageBucket: "eastern-shore-auction.firebasestorage.app",
  messagingSenderId: "771348898846",
  appId: "1:771348898846:web:3b6371e8f826747fdcba0f"
};

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        onAuthStateChanged(auth, (user) => {
            if (user) {
                get(child(ref(db), `admins/${user.uid}`)).then((snapshot) => {
                    if (!snapshot.exists() || snapshot.val() !== true) {
                        alert("Access Denied."); window.location.href = "index.html";
                    } else {
                        loadInventory();
                        loadUsers();
                        monitorActiveAuction();
                    }
                });
            } else {
                window.location.href = "index.html";
            }
        });

        window.switchView = function(viewName) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.getElementById(viewName + 'View').classList.add('active');
            if(viewName === 'add') {
                if(!document.getElementById('editKey').value) {
                     resetForm();
                }
            }
        }
        
        function resetForm() {
            document.querySelector('form').reset();
            document.getElementById('editKey').value = "";
            document.getElementById('formTitle').innerText = "Add New Lot";
        }

        // --- USER MANAGEMENT ---
        function loadUsers() {
            const userRef = ref(db, 'users');
            onValue(userRef, (snapshot) => {
                const tbody = document.getElementById('usersTableBody');
                tbody.innerHTML = "";
                const data = snapshot.val();
                if(!data) { tbody.innerHTML = "<tr><td colspan='6'>No registered users.</td></tr>"; return; }

                Object.entries(data).forEach(([key, user]) => {
                    const isApproved = user.is_approved === true;
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td><strong>${user.name}</strong></td>
                        <td>${user.email}</td>
                        <td>${user.is_local ? 'Yes' : 'No'}</td>
                        <td>${user.pickup_plan || "N/A"}</td>
                        <td><span class="status-pill ${isApproved ? 'status-approved' : 'status-pending'}">${isApproved ? 'Active' : 'Pending'}</span></td>
                        <td>${!isApproved ? `<button class="btn btn-queue" onclick="approveUser('${key}')">Approve</button>` : ''}</td>
                    `;
                    tbody.appendChild(tr);
                });
            });
        }

        window.approveUser = function(uid) {
            if(confirm("Approve this user to bid?")) {
                update(ref(db, `users/${uid}`), { is_approved: true });
            }
        }

        // --- INVENTORY MANAGEMENT ---
        function loadInventory() {
            const invRef = ref(db, 'inventory');
            onValue(invRef, (snapshot) => {
                const tbody = document.getElementById('inventoryTableBody');
                tbody.innerHTML = "";
                const data = snapshot.val();
                if(!data) { tbody.innerHTML = "<tr><td colspan='7'>No items.</td></tr>"; return; }

                const items = Object.entries(data).map(([key, val]) => ({ ...val, key }));
                items.sort((a, b) => a.lot - b.lot);

                items.forEach(item => {
                    const tr = document.createElement('tr');
                    tr.id = `row-${item.key}`; 
                    tr.dataset.defaultPrice = item.start_price;
                    const isChecked = item.is_featured ? 'checked' : '';

                    tr.innerHTML = `
                        <td style="text-align:center;"><input type="checkbox" ${isChecked} onchange="toggleFeatured('${item.key}', this.checked)"></td>
                        <td><strong>#${item.lot}</strong></td>
                        <td class="item-cell"><img src="${item.image_url}" class="img-preview"><span class="item-title">${item.title}</span></td>
                        <td>${item.seller_email || "N/A"}</td>
                        <td class="price-cell">Start: $${item.start_price}<br><small style="color:#999">Reserve: $${item.reserve_price || 0}</small></td>
                        <td><span class="status-pill ${item.times_run > 0 ? 'status-run' : 'status-new'}">${item.times_run || 0} Times</span></td>
                        <td>
                            <button class="btn btn-queue" onclick="queueItem('${item.key}')">üì¢ Queue</button>
                            <button class="btn btn-edit" onclick="editItem('${item.key}')">‚úèÔ∏è Edit</button>
                            <button class="btn btn-delete" onclick="deleteItem('${item.key}')">üóëÔ∏è</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            });
        }

        window.toggleFeatured = function(key, status) { update(ref(db, `inventory/${key}`), { is_featured: status }); }

        // --- LIVE MONITOR (UPDATED FOR RESERVE PRICE) ---
        let activeAuctionData = null;
        function monitorActiveAuction() {
            const activeRef = ref(db, 'active_auction');
            onValue(activeRef, (snapshot) => {
                activeAuctionData = snapshot.val();
                updateActiveRowUI();
            });
            setInterval(updateActiveRowUI, 1000);
        }

        function updateActiveRowUI() {
            // Reset UI
            document.querySelectorAll('.live-active-row, .live-ended-sold, .live-ended-unsold').forEach(row => {
                row.classList.remove('live-active-row', 'live-ended-sold', 'live-ended-unsold');
                const titleCell = row.querySelector('.item-title');
                const badge = row.querySelector('.live-badge, .sold-badge, .unsold-badge');
                if(badge) badge.remove();
                const priceCell = row.querySelector('.price-cell');
                const itemPrice = row.dataset.defaultPrice;
                // We don't have access to reserve price in dataset easily here without re-render, so simplistic reset:
                // Ideally, refresh inventory data, but for now just clearing text override:
                // (Simpler approach: Trigger a re-render if monitoring is too complex, but let's stick to this)
            });

            // Re-apply UI
            if (activeAuctionData && activeAuctionData.inventory_key) {
                const row = document.getElementById(`row-${activeAuctionData.inventory_key}`);
                if (row) {
                    const isEnded = Date.now() > activeAuctionData.end_time;
                    const bidder = activeAuctionData.high_bidder_name ? activeAuctionData.high_bidder_name : "No Bids";
                    const priceCell = row.querySelector('.price-cell');
                    const titleCell = row.querySelector('.item-title');
                    
                    const currentBid = activeAuctionData.current_bid || 0;
                    const reserve = activeAuctionData.reserve_price || 0;
                    const hasBidder = !!activeAuctionData.high_bidder_uid;

                    // Determine Status
                    if (isEnded) {
                        if (hasBidder && currentBid >= reserve) {
                            // SOLD
                            row.classList.add('live-ended-sold');
                            if (!row.querySelector('.sold-badge')) titleCell.insertAdjacentHTML('afterbegin', '<span class="sold-badge">SOLD</span>');
                            priceCell.innerHTML = `<span class="live-bid-info" style="color: #b45309;">SOLD: $${currentBid.toLocaleString()}</span><span class="live-bidder-name">Winner: ${bidder}</span>`;
                        } else {
                            // UNSOLD / RESERVE NOT MET
                            row.classList.add('live-ended-unsold');
                            if (!row.querySelector('.unsold-badge')) titleCell.insertAdjacentHTML('afterbegin', '<span class="unsold-badge">PASSED</span>');
                            priceCell.innerHTML = `<span class="live-bid-info" style="color: #6b7280;">Ended: $${currentBid.toLocaleString()}</span><span class="live-bidder-name" style="color:#dc2626;">Reserve Not Met</span>`;
                        }
                    } else {
                        // LIVE
                        row.classList.add('live-active-row');
                        if (!row.querySelector('.live-badge')) titleCell.insertAdjacentHTML('afterbegin', '<span class="live-badge">LIVE</span>');
                        priceCell.innerHTML = `<span class="live-bid-info" style="color: #10b981;">$${currentBid.toLocaleString()}</span><span class="live-bidder-name">High Bidder: ${bidder}</span>`;
                    }
                }
            }
        }

        // --- CRUD & QUEUE ---
        window.saveItem = function() {
            const key = document.getElementById('editKey').value;
            const data = {
                lot: parseInt(document.getElementById('inpLot').value),
                title: document.getElementById('inpTitle').value,
                subtitle: document.getElementById('inpSub').value,
                seller_email: document.getElementById('inpSeller').value,
                start_price: parseInt(document.getElementById('inpPrice').value),
                reserve_price: parseInt(document.getElementById('inpReserve').value) || 0, // CAPTURE RESERVE
                image_url: document.getElementById('inpImg').value,
                description: document.getElementById('inpDesc').value,
                times_run: 0, is_featured: false,
                images: {
                    thumb1: document.getElementById('inpThumb1').value,
                    thumb2: document.getElementById('inpThumb2').value,
                    thumb3: document.getElementById('inpThumb3').value,
                    thumb4: document.getElementById('inpThumb4').value
                }
            };

            if(key) {
                get(ref(db, `inventory/${key}`)).then((snap) => {
                    const existing = snap.val();
                    data.times_run = existing.times_run || 0; data.is_featured = existing.is_featured || false;
                    update(ref(db, `inventory/${key}`), data);
                    alert("Item Updated"); resetForm(); switchView('inventory');
                });
            } else {
                push(ref(db, 'inventory'), data);
                alert("Item Added"); resetForm(); switchView('inventory');
            }
        }

        window.deleteItem = function(key) { if(confirm("Delete item?")) remove(ref(db, `inventory/${key}`)); }

        window.editItem = function(key) {
            resetForm();
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.getElementById('addView').classList.add('active');
            document.getElementById('formTitle').innerText = "Edit Item";

            get(ref(db, `inventory/${key}`)).then((snapshot) => {
                const data = snapshot.val();
                document.getElementById('editKey').value = key;
                document.getElementById('inpLot').value = data.lot;
                document.getElementById('inpTitle').value = data.title;
                document.getElementById('inpSub').value = data.subtitle;
                document.getElementById('inpSeller').value = data.seller_email;
                document.getElementById('inpPrice').value = data.start_price;
                document.getElementById('inpReserve').value = data.reserve_price || ""; // LOAD RESERVE
                document.getElementById('inpImg').value = data.image_url;
                document.getElementById('inpDesc').value = data.description;
                if(data.images) {
                    document.getElementById('inpThumb1').value = data.images.thumb1 || "";
                    document.getElementById('inpThumb2').value = data.images.thumb2 || "";
                    document.getElementById('inpThumb3').value = data.images.thumb3 || "";
                    document.getElementById('inpThumb4').value = data.images.thumb4 || "";
                }
            });
        }

        window.queueItem = function(key) {
            if(!confirm("Put this item on the LIVE Auction Block?")) return;
            get(ref(db, `inventory/${key}`)).then((snapshot) => {
                const item = snapshot.val();
                const auctionData = {
                    title: item.title, subtitle: item.subtitle, description: item.description,
                    current_bid: item.start_price, image_url: item.image_url,
                    reserve_price: item.reserve_price || 0, // PASS RESERVE TO LIVE
                    end_time: Date.now() + (6 * 60 * 1000),
                    images: item.images,
                    high_bidder_max: 0, high_bidder_name: "", high_bidder_uid: "", bid_history: null,
                    inventory_key: key, seller_email: item.seller_email
                };
                set(ref(db, 'active_auction'), auctionData);
                update(ref(db, `inventory/${key}`), { times_run: (item.times_run || 0) + 1 });
                alert("Item is LIVE!");
            });
        }
    </script>
</body>
</html>