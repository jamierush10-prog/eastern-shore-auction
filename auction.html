<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Auction | Eastern Shore Auction House</title>
    <style>
        :root { --primary-color: #2563eb; --header-bg: #111827; --bg-color: #f3f4f6; --text-color: #1f2937; --accent-color: #dbeafe; --sold-color: #dc2626; }
        body { font-family: -apple-system, system-ui, sans-serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; display: flex; flex-direction: column; height: 100vh; }
        
        header { background-color: var(--header-bg); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .brand { font-family: "Georgia", serif; font-size: 1.5rem; font-weight: bold; }
        .user-info { display: flex; align-items: center; gap: 15px; }
        .nav-link { color: #d1d5db; text-decoration: none; cursor: pointer; font-size: 0.9rem; }
        .nav-link:hover { color: white; text-decoration: underline; }

        /* MAIN LAYOUT */
        .main-container { display: flex; flex: 1; overflow: hidden; position: relative; }
        .auction-stage { flex: 2; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 20px; }
        .sidebar { flex: 1; background: white; border-left: 1px solid #e5e7eb; display: flex; flex-direction: column; min-width: 300px; max-width: 400px; }
        
        /* AUCTION STAGE */
        .item-card { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.05); display: flex; flex-direction: column; }
        .item-image-container { width: 100%; height: 400px; background: #e5e7eb; position: relative; }
        .item-image { width: 100%; height: 100%; object-fit: contain; }
        .sold-overlay { position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.8); display:none; flex-direction: column; justify-content: center; align-items: center; z-index: 10; transition: opacity 0.3s; }
        .sold-stamp { border: 4px solid var(--sold-color); color: var(--sold-color); font-size: 3rem; font-weight: 900; padding: 10px 30px; text-transform: uppercase; transform: rotate(-10deg); margin-bottom: 10px; }
        
        .item-details { padding: 20px; }
        .item-title { font-size: 2rem; font-weight: bold; margin: 0 0 5px 0; }
        .item-lot { color: #6b7280; font-weight: bold; margin-bottom: 15px; }
        
        /* NEW: SELLER AVATAR */
        .seller-info { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; font-weight: 500; }
        .mini-avatar { width: 30px; height: 30px; border-radius: 50%; object-fit: cover; border: 2px solid #e5e7eb; background: #ccc; }

        .info-box { background: #f9fafb; padding: 15px; border-radius: 8px; border: 1px solid #e5e7eb; margin-bottom: 15px; font-size: 0.9rem; }
        .info-row { display: flex; gap: 10px; margin-bottom: 8px; }
        .info-icon { width: 20px; text-align: center; }

        /* SIDEBAR CONTROLS */
        .timer-box { background: #fee2e2; color: #991b1b; padding: 15px; text-align: center; font-size: 1.2rem; font-weight: bold; border-bottom: 1px solid #fca5a5; }
        .timer-ended { background: #e5e7eb; color: #374151; border-bottom: 1px solid #d1d5db; }
        
        .bidding-controls { padding: 20px; border-bottom: 1px solid #e5e7eb; }
        .current-bid-label { font-size: 0.9rem; color: #6b7280; text-transform: uppercase; letter-spacing: 1px; }
        .current-bid-amount { font-size: 3rem; font-weight: 800; margin: 5px 0 15px; color: #111827; }
        
        .high-bidder-box { background: var(--accent-color); padding: 10px; border-radius: 6px; margin-bottom: 20px; font-weight: 500; color: #1e40af; text-align: center; }
        .winning-box { background: #d1fae5; color: #065f46; border: 1px solid #34d399; animation: pulse 2s infinite; }

        .quick-bids { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .quick-btn { background: white; border: 1px solid var(--primary-color); color: var(--primary-color); padding: 10px; border-radius: 6px; font-weight: bold; cursor: pointer; transition: all 0.2s; }
        .quick-btn:hover { background: var(--accent-color); }
        
        .custom-bid-group { display: flex; gap: 10px; margin-bottom: 15px; }
        .custom-input { flex: 1; padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 1rem; }
        .bid-btn { width: 100%; padding: 15px; background: var(--primary-color); color: white; border: none; border-radius: 6px; font-size: 1.1rem; font-weight: bold; cursor: pointer; transition: background 0.2s; }
        .bid-btn:hover { background: #1d4ed8; }
        .bid-btn:disabled { background: #9ca3af; cursor: not-allowed; }

        /* TABS & LISTS */
        .sidebar-tabs { display: flex; border-bottom: 1px solid #e5e7eb; }
        .tab { flex: 1; text-align: center; padding: 15px; cursor: pointer; font-weight: bold; color: #6b7280; background: #f9fafb; }
        .tab.active { background: white; color: var(--primary-color); border-bottom: 3px solid var(--primary-color); }
        .tab-content { flex: 1; overflow-y: auto; display: none; }
        .tab-content.active { display: block; }

        .bid-list, .chat-list { padding: 0; margin: 0; list-style: none; }
        .bid-item { padding: 10px 20px; border-bottom: 1px solid #f3f4f6; display: flex; justify-content: space-between; align-items: center; font-size: 0.95rem; animation: slideIn 0.3s ease-out; }
        /* NEW: Bidder Avatar in history */
        .bidder-flex { display: flex; align-items: center; gap: 10px; font-weight: 500; }

        .bid-amount { font-weight: bold; color: var(--primary-color); }
        @keyframes slideIn { from { opacity:0; transform: translateX(-10px); } to { opacity:1; transform: translateX(0); } }

        .chat-input-box { padding: 15px; border-top: 1px solid #e5e7eb; display: flex; gap: 10px; }
        .chat-input { flex: 1; padding: 10px; border: 1px solid #ccc; border-radius: 20px; }
        .chat-btn { padding: 8px 15px; background: var(--header-bg); color: white; border: none; border-radius: 20px; cursor: pointer; }

        /* WINNER MODAL */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; justify-content: center; align-items: center; }
        .winner-modal { background: white; padding: 40px; border-radius: 12px; text-align: center; max-width: 400px; animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .winner-icon { font-size: 4rem; margin-bottom: 10px; }
        .winner-title { font-size: 2rem; font-weight: 900; color: var(--primary-color); margin-bottom: 10px; }
        @keyframes popIn { from { opacity:0; transform: scale(0.8); } to { opacity:1; transform: scale(1); } }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(52, 211, 153, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(52, 211, 153, 0); } 100% { box-shadow: 0 0 0 0 rgba(52, 211, 153, 0); } }

        @media (max-width: 768px) { .main-container { flex-direction: column; overflow-y: auto; } .sidebar { width: 100%; max-width: none; border-left: none; border-top: 1px solid #e5e7eb; height: 500px; } .item-image-container { height: 300px; } }
    </style>
</head>
<body>

    <header>
        <div class="brand">Eastern Shore Auction House</div>
        <div class="user-info">
            <span id="userNameDisplay">Welcome</span>
            | <a href="account.html" class="nav-link">My Account</a>
        </div>
    </header>

    <div class="main-container">
        <div class="auction-stage">
            <div class="item-card">
                <div class="item-image-container">
                    <img id="mainImage" src="https://placehold.co/600x400?text=Waiting+for+Auction..." class="item-image">
                    <div id="soldOverlay" class="sold-overlay">
                        <div class="sold-stamp">SOLD!</div>
                        <div id="soldDetails" style="font-size: 1.2rem; font-weight: bold; color: #374151;"></div>
                    </div>
                </div>
                <div class="item-details">
                    <h1 id="itemTitle" class="item-title">Waiting for auction to begin...</h1>
                    <div id="itemLot" class="item-lot">Lot # -</div>
                    
                    <div class="seller-info">
                        <img id="sellerAvatar" src="https://www.gravatar.com/avatar/?d=mp" class="mini-avatar">
                        Seller: <span id="itemSeller">...</span>
                    </div>

                    <div class="info-box">
                        <div class="info-row"><div class="info-icon">üìç</div><div id="itemLoc">Location not specified</div></div>
                        <div class="info-row"><div class="info-icon">üíµ</div><div id="itemPay">Payment: Cash/Venmo</div></div>
                        <div class="info-row"><div class="info-icon">üöö</div><div id="itemDel">Delivery: Pickup</div></div>
                    </div>
                    <div style="margin-top: 15px;">
                        <strong>Description:</strong>
                        <p id="itemDesc" style="line-height: 1.5; color: #4b5563;">Please wait for the next item to hit the block.</p>
                    </div>
                </div>
            </div>
            </div>

        <div class="sidebar">
            <div id="timerBox" class="timer-box timer-ended">TIME REMAINING: <span id="timeRemaining">--:--</span></div>
            
            <div class="bidding-controls">
                <div class="current-bid-label">CURRENT BID</div>
                <div id="currentBid" class="current-bid-amount">$0</div>
                <div id="highBidderBox" class="high-bidder-box">High Bidder: None</div>

                <div class="quick-bids">
                    <button class="quick-btn" onclick="placeQuickBid(1)">+$1</button>
                    <button class="quick-btn" onclick="placeQuickBid(5)">+$5</button>
                    <button class="quick-btn" onclick="placeQuickBid(10)">+$10</button>
                </div>
                <div class="custom-bid-group">
                    <input type="number" id="customBidInput" class="custom-input" placeholder="Enter amount">
                    <button class="quick-btn" style="flex:none; padding:10px 20px;" onclick="placeCustomBid()">Place Bid</button>
                </div>
                <button id="mainBidBtn" class="bid-btn" disabled>Auction Closed</button>
                 <div style="text-align: center; margin-top: 5px; font-size: 0.8rem; color: #6b7280;">
                    <label style="cursor:pointer;"><input type="checkbox" id="confirmCheck" style="vertical-align: middle;"> I agree to purchase if I win.</label>
                </div>
            </div>

            <div class="sidebar-tabs">
                <div class="tab active" onclick="switchTab('history')">Bid History</div>
                <div class="tab" onclick="switchTab('chat')">Floor Chat</div>
            </div>
            
            <div id="historyTab" class="tab-content active">
                <ul id="bidList" class="bid-list">
                    </ul>
            </div>
            <div id="chatTab" class="tab-content" style="display: flex; flex-direction: column; height: 100%;">
                 <ul id="chatList" class="chat-list" style="flex: 1; overflow-y: auto; padding: 15px;">
                    <li style="color:#999; text-align:center;">Chat coming soon...</li>
                 </ul>
                 <div class="chat-input-box">
                     <input type="text" class="chat-input" placeholder="Say something..." disabled>
                     <button class="chat-btn" disabled>Send</button>
                 </div>
            </div>

        </div>
    </div>

    <div id="winnerModal" class="modal-overlay">
        <div class="winner-modal">
            <div class="winner-icon">üéâ</div>
            <div class="winner-title">SOLD!</div>
            <p style="font-size: 1.2rem; color: #374151; margin-bottom: 20px;">
                Sold to <strong id="winnerName">...</strong> for <strong id="winnerPrice">$...</strong>
            </p>
            <button onclick="closeWinnerModal()" class="bid-btn" style="background: var(--header-bg);">Close</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, onValue, set, runTransaction, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // --- PASTE KEYS HERE ---
       const firebaseConfig = {
  apiKey: "AIzaSyCt0i8a7ZVRlNmSts9yM4uGwV7ghPU59rk",
  authDomain: "eastern-shore-auction.firebaseapp.com",
  databaseURL: "https://eastern-shore-auction-default-rtdb.firebaseio.com",
  projectId: "eastern-shore-auction",
  storageBucket: "eastern-shore-auction.firebasestorage.app",
  messagingSenderId: "771348898846",
  appId: "1:771348898846:web:3b6371e8f826747fdcba0f"
};

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        let currentUser = null;
        let auctionData = null;
        let timerInterval = null;
        let isAuctionEnded = true;
        // NEW: Cache for user data to quickly find avatar URLs
        let userCache = {}; 
        const default AvatarStr = "https://www.gravatar.com/avatar/00000000000000000000000000000000?d=mp&f=y";


        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('userNameDisplay').innerText = `Welcome, ${user.displayName}`;
                // 1. Preload all users for avatar lookups
                preloadUserCache();
                // 2. Start listening to auction data
                listenToAuction();
            } else {
                window.location.href = "index.html";
            }
        });

        // --- NEW: PRELOAD USERS FOR AVATARS ---
        function preloadUserCache() {
            get(ref(db, 'users')).then((snapshot) => {
                if (snapshot.exists()) {
                    const users = snapshot.val();
                    // Map user names to their data for easy lookup by name
                    Object.values(users).forEach(userData => {
                        if(userData.name) {
                            userCache[userData.name] = userData;
                        }
                    });
                    // If auction data already loaded, refresh UI to show avatars
                    if(auctionData) updateUI(); 
                }
            });
        }

        // Helper to find avatar URL by name
        function getAvatarUrlByName(name) {
            if (userCache[name] && userCache[name].profile_image_url) {
                return userCache[name].profile_image_url;
            }
            return defaultAvatarStr;
        }


        function listenToAuction() {
            onValue(ref(db, 'active_auction'), (snapshot) => {
                auctionData = snapshot.val();
                updateUI();
            });
        }

        function updateUI() {
            if (!auctionData) return;

            // Basic Info
            document.getElementById('itemTitle').innerText = auctionData.title || "Auction Closed";
            document.getElementById('itemLot').innerText = auctionData.lot ? `Lot #${auctionData.lot}` : "Lot # -";
            document.getElementById('itemDesc').innerText = auctionData.description || "Check back later for the next item.";
            document.getElementById('mainImage').src = auctionData.image_url || "https://placehold.co/600x400?text=Auction+House";
            
            // NEW: Update Seller Info & Avatar
            const sellerName = auctionData.seller_name || "House";
            document.getElementById('itemSeller').innerText = sellerName;
            document.getElementById('sellerAvatar').src = getAvatarUrlByName(sellerName);

            document.getElementById('itemLoc').innerText = auctionData.location || "Not Specified";
            document.getElementById('itemPay').innerText = auctionData.payment_methods || "Cash/Venmo";
            document.getElementById('itemDel').innerText = auctionData.delivery_method || "Pickup";

            // Bidding Info
            const currentBid = auctionData.current_bid || 0;
            document.getElementById('currentBid').innerText = `$${currentBid.toLocaleString()}`;

            const highBidderName = auctionData.high_bidder_name || "None";
            const bidderBox = document.getElementById('highBidderBox');
            bidderBox.innerText = `High Bidder: ${highBidderName}`;
            
            if (currentUser && auctionData.high_bidder_uid === currentUser.uid) {
                 bidderBox.innerText = "üéâ You are the high bidder!";
                 bidderBox.classList.add('winning-box');
            } else {
                 bidderBox.classList.remove('winning-box');
            }

            // Timer Logic
            const now = Date.now();
            const endTime = auctionData.end_time || 0;
            isAuctionEnded = now >= endTime;
            
            const timerBox = document.getElementById('timerBox');
            const mainBtn = document.getElementById('mainBidBtn');
            const soldOverlay = document.getElementById('soldOverlay');

            if (isAuctionEnded) {
                clearInterval(timerInterval);
                document.getElementById('timeRemaining').innerText = "ENDED";
                timerBox.classList.add('timer-ended');
                mainBtn.innerText = "Auction Closed";
                mainBtn.disabled = true;

                if (auctionData.high_bidder_name) {
                    soldOverlay.style.display = 'flex';
                    setTimeout(() => soldOverlay.style.opacity = '1', 10);
                    document.getElementById('soldDetails').innerText = `Sold to ${auctionData.high_bidder_name} for $${currentBid}`;
                    // Check if we just won to show modal once
                    // (In a real app, you'd use a separate 'status' field to trigger this only once)
                } else {
                     soldOverlay.style.display = 'none';
                     soldOverlay.style.opacity = '0';
                }

            } else {
                timerBox.classList.remove('timer-ended');
                mainBtn.innerText = "Place Max Bid";
                mainBtn.disabled = false;
                soldOverlay.style.display = 'none';
                soldOverlay.style.opacity = '0';
                if (!timerInterval) timerInterval = setInterval(updateTimer, 1000);
            }

            // History List - UPDATED WITH AVATARS
            const bidList = document.getElementById('bidList');
            bidList.innerHTML = "";
            if (auctionData.bid_history) {
                // Reverse order to show newest first
                const history = Object.values(auctionData.bid_history).reverse();
                history.forEach(bid => {
                    const li = document.createElement('li');
                    li.className = 'bid-item';
                    // Use helper to get avatar url based on bidder name
                    const avatarUrl = getAvatarUrlByName(bid.bidder_name);
                    li.innerHTML = `
                        <div class="bidder-flex">
                            <img src="${avatarUrl}" class="mini-avatar">
                            <span>${bid.bidder_name}</span>
                        </div>
                        <span class="bid-amount">$${bid.amount.toLocaleString()}</span>
                    `;
                    bidList.appendChild(li);
                });
            }
        }

        function updateTimer() {
            const now = Date.now();
            const timeLeft = auctionData.end_time - now;
            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                timerInterval = null;
                updateUI(); // Will handle ended state
                return;
            }
            const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
            document.getElementById('timeRemaining').innerText = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            const timerBox = document.getElementById('timerBox');
            if (timeLeft < 30000) { // Less than 30s
                timerBox.style.backgroundColor = (seconds % 2 === 0) ? "#fee2e2" : "#fca5a5"; // Flash red
            } else {
                 timerBox.style.backgroundColor = "#fee2e2";
            }
        }

        // --- BIDDING ACTIONS ---
        window.placeQuickBid = function(increment) {
            if (isAuctionEnded || !auctionData) return;
            const nextBid = (auctionData.current_bid || 0) + increment;
            submitBid(nextBid);
        }

        window.placeCustomBid = function() {
             if (isAuctionEnded || !auctionData) return;
             const input = document.getElementById('customBidInput');
             const amount = parseInt(input.value);
             if(amount > 0) {
                 submitBid(amount);
                 input.value = "";
             }
        }

        function submitBid(amount) {
            if (!document.getElementById('confirmCheck').checked) {
                alert("Please check the box to confirm you agree to purchase.");
                return;
            }
            if (amount <= (auctionData.current_bid || 0)) {
                alert("Bid must be higher than current bid.");
                return;
            }

            const bidRef = ref(db, 'active_auction');
            runTransaction(bidRef, (currentData) => {
                if (currentData && amount > (currentData.current_bid || 0)) {
                    // Soft Close Logic: Extend if < 30s remains
                    let newEndTime = currentData.end_time;
                    const now = Date.now();
                    if (currentData.end_time - now < 30000) {
                        newEndTime = now + 30000; 
                    }
                    
                    currentData.current_bid = amount;
                    currentData.high_bidder_name = currentUser.displayName;
                    currentData.high_bidder_uid = currentUser.uid;
                    currentData.end_time = newEndTime;

                    if (!currentData.bid_history) currentData.bid_history = {};
                    const newBidKey = 'bid_' + Date.now();
                    currentData.bid_history[newBidKey] = {
                        bidder_name: currentUser.displayName,
                        amount: amount,
                        time: Date.now()
                    };
                    return currentData;
                } else {
                    return; // Abort if someone else bid higher first
                }
            }).then((result) => {
                if (!result.committed) {
                    alert("Someone placed a higher bid just before you. Try again!");
                }
                document.getElementById('confirmCheck').checked = false; // Reset Checkbox
            });
        }

        // --- TABS & MODALS ---
        window.switchTab = function(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            if(tabName === 'history') {
                document.querySelectorAll('.tab')[0].classList.add('active');
                document.getElementById('historyTab').classList.add('active');
            } else {
                 document.querySelectorAll('.tab')[1].classList.add('active');
                 document.getElementById('chatTab').classList.add('active');
            }
        }
        window.closeWinnerModal = function() {
            document.getElementById('winnerModal').style.display = 'none';
        }
    </script>
</body>
</html>