<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Auction Room</title>
    <style>
        /* --- CSS STYLES --- */
        :root { --primary-color: #2563eb; --urgent-color: #dc2626; --bg-color: #f3f4f6; --text-color: #1f2937; --border-color: #e5e7eb; --header-bg: #111827; --header-text: #f9fafb; --success-color: #16a34a; }
        body { font-family: -apple-system, system-ui, sans-serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        
        .site-header { width: 100%; background-color: var(--header-bg); color: var(--header-text); padding: 20px 0; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 40px; position: relative; display: flex; justify-content: center; align-items: center; }
        .brand-name { font-size: 1.8rem; letter-spacing: 1.5px; font-weight: bold; text-transform: uppercase; cursor:pointer; }
        .header-left { position: absolute; left: 20px; display: flex; gap: 15px; align-items: center; }
        .nav-link { color: #d1d5db; text-decoration: none; font-size: 0.9rem; cursor: pointer; }
        .header-right { position: absolute; right: 20px; display: flex; gap: 15px; align-items: center; } 
        .viewer-count { font-size: 0.9rem; color: #9ca3af; display: none; align-items: center; gap: 5px; font-weight: bold; }

        .auction-container { background: white; max-width: 1000px; width: 90%; display: grid; grid-template-columns: 1.2fr 1fr; gap: 40px; padding: 40px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); margin-bottom: 40px; }
        .main-image-wrapper { width: 100%; height: 400px; background-color: #eee; border-radius: 8px; overflow: hidden; border: 1px solid var(--border-color); }
        .main-image-wrapper img { width: 100%; height: 100%; object-fit: contain; background: #fff; }

        .details-section { display: flex; flex-direction: column; }
        h1 { margin: 0 0 10px 0; font-size: 2rem; line-height: 1.1; }
        .seller-info { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; font-weight: 500; color: #4b5563; }
        
        .timer-block { background-color: #fee2e2; color: var(--urgent-color); padding: 15px; border-radius: 8px; display: flex; align-items: center; justify-content: space-between; margin-bottom: 30px; font-weight: bold; border: 1px solid #fca5a5; }
        .timer-ended { background-color: #e5e7eb; color: #374151; border-color: #d1d5db; }
        .countdown { font-size: 1.5rem; font-variant-numeric: tabular-nums; }
        
        .pricing-card { background-color: #f9fafb; padding: 25px; border-radius: 8px; border: 1px solid var(--border-color); margin-bottom: 20px; }
        .current-price { font-size: 3rem; font-weight: 800; color: var(--text-color); margin: 5px 0 20px 0; }
        
        .bid-controls { display: flex; flex-direction: column; gap: 15px; }
        .increment-buttons { display: flex; gap: 10px; }
        .inc-btn { flex: 1; padding: 10px; background: white; border: 1px solid var(--primary-color); color: var(--primary-color); border-radius: 4px; font-weight: bold; cursor: pointer; transition: all 0.2s; }
        .inc-btn:hover { background: var(--primary-color); color: white; }
        .bid-input-row { position: relative; width: 100%; }
        input#bidInput { padding: 12px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 1.2rem; font-weight: bold; width: 100%; box-sizing: border-box; text-align: center; }
        button.bid-btn { background-color: var(--primary-color); color: white; border: none; padding: 12px 24px; border-radius: 6px; font-size: 1rem; font-weight: 600; cursor: pointer; width: 100%; }
        button.bid-btn:hover { background-color: #1d4ed8; }
        button.bid-btn:disabled { background-color: #9ca3af; cursor: not-allowed; }
        
        .chat-section { margin-top: 20px; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; padding: 15px; }
        .chat-window { height: 200px; overflow-y: auto; background: white; border: 1px solid #e5e7eb; border-radius: 6px; padding: 10px; margin-bottom: 10px; display: flex; flex-direction: column; gap: 8px; }
        .chat-msg { font-size: 0.9rem; line-height: 1.4; }
        .chat-msg strong { color: var(--primary-color); margin-right: 5px; }
        .chat-input-row { display: flex; gap: 10px; }
        #chatInput { padding: 10px; border: 1px solid #ccc; border-radius: 6px; flex: 1; font-size: 0.9rem; }
        .chat-btn { background-color: #374151; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; }

        @media (max-width: 768px) {
            .auction-container { grid-template-columns: 1fr; width: 95%; padding: 15px; gap: 20px; }
            .main-image-wrapper { height: 250px; }
        }
    </style>
</head>
<body>

    <header class="site-header">
        <div class="header-left">
            <a href="index.html" class="nav-link">&larr; Back to Market</a>
        </div>
        <div class="brand-name" onclick="window.location.href='index.html'">The Auction House</div>
        <div class="header-right">
            <div id="liveViewers" class="viewer-count">üëÅÔ∏è 1 Viewing</div>
            <div onclick="logout()" class="nav-link">Sign Out</div>
        </div>
    </header>

    <div class="auction-container">
        <div class="gallery-section">
            <div class="main-image-wrapper"><img id="mainImage" src="" alt="Auction Item" onerror="this.src='https://placehold.co/600x400?text=No+Image'"></div>
            <div style="margin-top:20px; border-top:1px solid #eee; padding-top:20px;">
                <strong>Recent Bids:</strong>
                <div id="bidHistoryList" style="margin-top:10px; font-size:0.9rem; color:#666;"></div>
            </div>
        </div>

        <div class="details-section">
            <h1 id="itemTitle">Loading...</h1>
            <div id="sellerInfo" class="seller-info">Seller: <strong id="sellerName">...</strong></div>
            
            <div style="background:#f9fafb; padding:15px; border-radius:8px; margin-bottom:20px; font-size:0.9rem;">
                <div><strong>Location:</strong> <span id="dispLoc">...</span></div>
                <div style="margin-top:5px; color:#555;" id="itemDescription">...</div>
            </div>

            <div class="timer-block" id="timerBox"><span>TIME REMAINING</span><span class="countdown" id="countdown">--:--:--</span></div>

            <div class="pricing-card">
                <div style="text-transform:uppercase; color:#6b7280; font-size:0.85rem; letter-spacing:1px;">Current Bid</div>
                <div class="current-price" id="priceDisplay">...</div>
                <div class="bid-controls">
                    <div style="text-align:center; font-size:0.9rem; margin-bottom:10px;">Bidder: <strong id="displayUsername">...</strong></div>
                    <div class="increment-buttons">
                        <button class="inc-btn" onclick="addToBid(1)">+$1</button>
                        <button class="inc-btn" onclick="addToBid(5)">+$5</button>
                        <button class="inc-btn" onclick="addToBid(10)">+$10</button>
                    </div>
                    <div class="bid-input-row"><input type="number" id="bidInput" placeholder="Enter Bid Amount"></div>
                    <button class="bid-btn" id="mainBidBtn" onclick="submitBid()">Place Bid</button>
                </div>
            </div>

            <div class="chat-section">
                <div style="font-weight:bold; margin-bottom:10px;">üí¨ Item Chat</div>
                <div id="chatWindow" class="chat-window"></div>
                <form class="chat-input-row" onsubmit="event.preventDefault(); sendChat();">
                    <input type="text" id="chatInput" placeholder="Ask a question..." autocomplete="off">
                    <button type="submit" class="chat-btn">Send</button>
                </form>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, onValue, set, get, push, update, child, query, limitToLast, remove, onDisconnect } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
          apiKey: "AIzaSyCt0i8a7ZVRlNmSts9yM4uGwV7ghPU59rk",
          authDomain: "eastern-shore-auction.firebaseapp.com",
          databaseURL: "https://eastern-shore-auction-default-rtdb.firebaseio.com",
          projectId: "eastern-shore-auction",
          storageBucket: "eastern-shore-auction.firebasestorage.app",
          messagingSenderId: "771348898846",
          appId: "1:771348898846:web:3b6371e8f826747fdcba0f"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // 1. GET AUCTION ID FROM URL
        const urlParams = new URLSearchParams(window.location.search);
        const auctionId = urlParams.get('id');

        if (!auctionId) {
            alert("No auction specified. Returning to marketplace.");
            window.location.href = "index.html";
        }

        // 2. REFERENCE TO SPECIFIC AUCTION
        const dbRef = ref(db, `auctions/${auctionId}`);
        const chatRef = query(ref(db, `auctions/${auctionId}/chat`), limitToLast(50));

        let currentUser = null;
        let globalAuctionData = null;
        let timerInterval = null;

        onAuthStateChanged(auth, (user) => {
            if (user) {
                // Check if suspended
                get(child(ref(db), `users/${user.uid}`)).then((snapshot) => {
                    if (snapshot.exists() && snapshot.val().is_approved === false) {
                        alert("Account suspended.");
                        signOut(auth).then(() => window.location.href = "index.html");
                    } else {
                        currentUser = user;
                        document.getElementById('displayUsername').innerText = user.displayName || "Bidder";
                        
                        // Check Admin for Viewers
                        get(child(ref(db), `admins/${user.uid}`)).then((adminSnap) => { 
                            if (adminSnap.exists() && adminSnap.val() === true) {
                                document.getElementById('liveViewers').style.display = 'flex';
                            }
                        });
                    }
                });
            } else {
                alert("Please log in to view this auction.");
                window.location.href = "index.html";
            }
        });

        window.logout = function() { signOut(auth).then(() => { window.location.href = "index.html"; }); }

        // --- LOAD AUCTION DATA ---
        onValue(dbRef, (snapshot) => {
            const data = snapshot.val();
            if (data) {
                globalAuctionData = data;
                
                // LAZY ENDING LOGIC
                // If time is up but DB still says 'live', the first person viewing closes it.
                if (data.status !== 'ended' && Date.now() > data.end_time) {
                    update(dbRef, { status: "ended" });
                }

                updateUI(data);
                renderBidHistory(data.bid_history);
            } else {
                alert("Auction not found.");
                window.location.href = "index.html";
            }
        });

        function updateUI(data) {
            document.getElementById('itemTitle').innerText = data.title;
            document.getElementById('sellerName').innerText = data.seller_name;
            document.getElementById('itemDescription').innerText = data.description;
            document.getElementById('dispLoc').innerText = data.location || "N/A";
            document.getElementById('priceDisplay').innerText = "$" + data.current_bid.toLocaleString();
            document.getElementById('mainImage').src = data.image_url;

            // Update Input default
            const input = document.getElementById('bidInput');
            if(document.activeElement !== input) input.value = data.current_bid + 1;

            updateTimer(data.end_time, data.status);
        }

        function updateTimer(endTime, status) {
            if (timerInterval) clearInterval(timerInterval);
            
            const tick = () => {
                const now = Date.now();
                const distance = endTime - now;
                const timerElement = document.getElementById('countdown');
                const bidBtn = document.getElementById('mainBidBtn');

                if (status === 'ended' || distance < 0) {
                    clearInterval(timerInterval);
                    timerElement.innerText = "ENDED";
                    document.getElementById('timerBox').classList.add('timer-ended');
                    bidBtn.disabled = true;
                    bidBtn.innerText = "Auction Ended";
                    return;
                }

                // Math for HH:MM:SS
                const hours = Math.floor(distance / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);

                const h = hours < 10 ? "0" + hours : hours;
                const m = minutes < 10 ? "0" + minutes : minutes;
                const s = seconds < 10 ? "0" + seconds : seconds;

                timerElement.innerText = h + ":" + m + ":" + s;
                bidBtn.disabled = false;
                bidBtn.innerText = "Place Bid";
            };
            
            tick(); // Run immediately
            timerInterval = setInterval(tick, 1000);
        }

        // --- BIDDING ---
        window.addToBid = function(amount) {
            const current = globalAuctionData ? globalAuctionData.current_bid : 0;
            document.getElementById('bidInput').value = current + amount; 
        }

        window.submitBid = function() {
            if(!currentUser) return;
            const bidAmount = parseInt(document.getElementById('bidInput').value);
            
            if(!globalAuctionData) return;
            if(globalAuctionData.status === 'ended') { alert("Auction Ended"); return; }
            if(bidAmount <= globalAuctionData.current_bid) { alert("Bid must be higher than current price."); return; }

            // Optimistic UI update not needed, Firebase is fast
            const updates = {
                current_bid: bidAmount,
                high_bidder_uid: currentUser.uid,
                high_bidder_name: currentUser.displayName
            };

            // Extend timer if < 30s left (Anti-Sniping)
            const now = Date.now();
            if (globalAuctionData.end_time - now < 30000) {
                updates.end_time = now + 30000; 
            }

            update(dbRef, updates);

            // Add to history
            push(child(dbRef, 'bid_history'), {
                bidder: currentUser.displayName,
                amount: bidAmount,
                time: Date.now()
            });
        }

        function renderBidHistory(history) {
            const list = document.getElementById('bidHistoryList');
            list.innerHTML = "";
            if(!history) { list.innerText = "No bids yet."; return; }
            
            const bids = Object.values(history).sort((a,b) => b.amount - a.amount); // High to low
            
            bids.slice(0, 5).forEach(bid => {
                const div = document.createElement('div');
                div.innerHTML = `<strong>${bid.bidder}</strong>: $${bid.amount}`;
                list.appendChild(div);
            });
        }

        // --- CHAT ---
        window.sendChat = function() {
            const input = document.getElementById('chatInput');
            const txt = input.value.trim();
            if(!txt || !currentUser) return;
            
            push(ref(db, `auctions/${auctionId}/chat`), {
                user: currentUser.displayName,
                text: txt,
                timestamp: Date.now()
            });
            input.value = "";
        }

        onValue(chatRef, (snapshot) => {
            const chatWindow = document.getElementById('chatWindow');
            chatWindow.innerHTML = "";
            const data = snapshot.val();
            if(data) {
                Object.values(data).forEach(msg => {
                    const div = document.createElement('div');
                    div.className = 'chat-msg';
                    div.innerHTML = `<strong>${msg.user}:</strong> ${msg.text}`;
                    chatWindow.appendChild(div);
                });
                chatWindow.scrollTop = chatWindow.scrollHeight;
            }
        });

    </script>
</body>
</html>